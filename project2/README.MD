# BUNDLE
## Установка
features:install hibernate
install -s mvn:ru.cinimex.learn/database/1.0-SNAPSHOT
ДОБАВЬ МОДЕЛь
install -s mvn:ru.cinimex.learn/route/1.0-SNAPSHOT
install -s mvn:ru.cinimex.learn/phonebookWS/1.0-SNAPSHOT


# FEATURE 
### Fisrt run
please delete data at \jboss-fuse-6.3.0.redhat-254\ or profile 
features:addurl mvn:ru.cinimex.learn/features/1.0-SNAPSHOT/xml/features
features:install first_run
list

### Run 2 services
uninstall phonebookWS
uninstall route
features:refreshUrl
features:install all_Services
list

### Run only route
uninstall route
features:refreshUrl
features:install general
list

### End
features:uninstall
uninstall
features:removeUrl mvn:ru.cinimex.learn/features/1.0-SNAPSHOT/xml/features
features:listurl

# Test
http://localhost:8181/cxf



# Постановка задачи

Задание второе.

В БД PostgreSQL создаем таблицу Customer:
CREATE SEQUENCE customer_seq START 1;
CREATE TABLE Customers (CUSTOMER_ID NUMERIC(38, 0) NOT NULL PRIMARY KEY,
                                   FIRST_NAME character varying(100) NOT NULL,
                                   LAST_NAME character varying(100) NOT NULL,
                                   MIDDLE_NAME character varying(100),
                                   PHONE NUMERIC(38, 0) NOT NULL,
                                   EMAIL character varying(100);

Шина выставляет SOAP веб-сервис CustomerWS с двумя методами:
- createCustomer
- getCustomerByPhone

Примеры форматов:

1) createCustomer 

Запрос:
<?xml version="1.0" encoding="UTF-8"?>
<!--Sample XML file generated by XMLSpy v2011 rel. 2 (http://www.altova.com)-->
<tns:CreateCustomerRequest xmlns:tns="http://cinimex.ru/learning/esb" xmlns:cust="http://cinimex.ru/learning/esb/customer" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
   <Customers>
      <cust:Customer>
         <cust:FirstName>Ivan</cust:FirstName>
         <cust:MiddleName>Fedorovich</cust:MiddleName>
         <cust:LastName>Kruzinshtern</cust:LastName>
         <cust:PhoneNumber>+7(965)300-12-12</cust:PhoneNumber>
         <cust:Email>chelovek_i_parohod@gmail.com</cust:Email>
      </cust:Customer>
      <cust:Customer>
         <cust:FirstName>Fedor</cust:FirstName>
         <cust:MiddleName>Petrovich</cust:MiddleName>
         <cust:LastName>Beznomernoi</cust:LastName>
         <cust:PhoneNumber/>
         <cust:Email>manwithinvalidemail</cust:Email>
      </cust:Customer>
   </Customers>
</tns:CreateCustomerRequest>
Ответ:
<?xml version="1.0" encoding="UTF-8"?>
<tns:CreateCustomerResponse xmlns:tns="http://cinimex.ru/learning/esb" xmlns:cust="http://cinimex.ru/learning/esb/customer" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <CustomersResult>
    <cust:Customer>
      <cust:CustomerId>1</cust:CustomerId>
      <cust:FirstName>Ivan</cust:FirstName>
      <cust:MiddleName>Fedorovich</cust:MiddleName>
      <cust:LastName>Kruzinshtern</cust:LastName>
      <cust:PhoneNumber>+7(965)300-12-12</cust:PhoneNumber>
      <cust:Email>chelovek_i_parohod@gmail.com</cust:Email>
      <cust:Status>Created</cust:Status>
    </cust:Customer>
    <cust:Customer>
      <cust:CustomerId>2</cust:CustomerId>
      <cust:FirstName>Fedor</cust:FirstName>
      <cust:MiddleName>Petrovich</cust:MiddleName>
      <cust:LastName>Beznomernoi</cust:LastName>
      <cust:PhoneNumber>+7(965)999-74-85</cust:PhoneNumber>
      <cust:Email/>
      <cust:Status>Created</cust:Status>
    </cust:Customer>
  </CustomersResult>
</tns:CreateCustomerResponse>

2) getCustomerByPhone 

Запрос:
<tns:GetCustomerByPhone xmlns:tns="http://cinimex.ru/learning/esb" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
   <PhoneList>
      <Phone>+7(965)300-12-12</Phone>
      <Phone>+7(965)999-74-85</Phone>
      <Phone>+7(965)999-74-99</Phone>
   </PhoneList>
</tns:GetCustomerByPhone>

Ответ:
<?xml version="1.0" encoding="UTF-8"?>
<tns:GetCustomerByPhoneResponse xmlns:tns="http://cinimex.ru/learning/esb" xmlns:cust="http://cinimex.ru/learning/esb/customer" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <CustomersResult>
    <cust:Customer>
      <cust:CustomerId>1</cust:CustomerId>
      <cust:FirstName>Ivan</cust:FirstName>
      <cust:MiddleName>Fedorovich</cust:MiddleName>
      <cust:LastName>Kruzinshtern</cust:LastName>
      <cust:PhoneNumber>+7(965)300-12-12</cust:PhoneNumber>
      <cust:Email>chelovek_i_parohod@gmail.com</cust:Email>
      <cust:Status>Created</cust:Status>
    </cust:Customer>
    <cust:Customer>
      <cust:CustomerId>2</cust:CustomerId>
      <cust:FirstName>Fedor</cust:FirstName>
      <cust:MiddleName>Petrovich</cust:MiddleName>
      <cust:LastName>Beznomernoi</cust:LastName>
      <cust:PhoneNumber>+7(965)999-74-85</cust:PhoneNumber>
      <cust:Email/>
      <cust:Status>Created</cust:Status>
    </cust:Customer>
    <cust:Customer>
      <cust:FirstName>NOT_FOUND</cust:FirstName>
      <cust:LastName>NOT_FOUND</cust:LastName>
      <cust:PhoneNumber>+7(965)999-74-99</cust:PhoneNumber>
    </cust:Customer>
  </CustomersResult>
</tns:GetCustomerByPhoneResponse>

Тебе необходимо написать XSD для типа cust:Customer, а также XSD всех запросов/ответов и собрать все в рабочий WSDL.
Далее поднять сервис на шине и описать логику.

Алгоритм работы.
1) createCustomer
- CustomerWS принимает запрос на создание клиента (как видишь, клиентов может быть несколько, от 1 до условной бесконечности).
- Валидирует тело запроса по схеме.
- Если запрос невалидный - шина возвращает SOAP-FAULT.
	- обрати внимание, что так как по схеме БД поля FirstName, LastName и Phone - обязательные - отсутствие полей FirstName и LastName делает запрос невалидным сразу по схеме (должно быть заложено в XSD). Поле Phone может быть пустым. Про него ниже.
- Если запрос валидный - шина формирует запись в БД, выполняя проверки:
	- если поле Email содержит некорректный Email - не записываем Email в БД.
	- если поле Phone пустое - шина выполняет запрос к внешнему сервису getPhoneByFIO:
		- если поле Phone получено - записываем всю запись в БД, статус создания клиента - Created.
		- если поле Phone не получено (getPhoneByFIO не вернул ответ в течение таймаута или вернул отрицательный ответ) - запись в БД по этому конкретному клиенту не создается, статус создания - Error_CannotGetPhone.
- Далее шина формирует ответ веб-сервиса CreateCustomerResponse, куда записывает данные по созданным клиентам, включая полученный номер (если имеется), созданный CUSTOMER_ID в БД и статус их создания согласно алгоритму.
2) getCustomerByPhone
- CustomerWS принимает запрос на получение клиента по номеру телефона.
- Валидирует тело запроса по схеме.
- Если запрос невалидный - шина возвращает SOAP-FAULT.
- Выполняет поиск в БД таких клиентов.
- Если клиент найден - возвращаем его.
- Если клиент не найден - возвращаем обязательные по XSD схеме Customer поля со значением NOT_FOUND.
- Возвращаем ответ.

Сервис getPhoneByFIO принимает на вход соответственно ФИО клиента (строго по одному клиенту за один запрос) в XML и вовзращает его номер (или возвращает NotFound). 
Формат придумай сама :) XML на вход, XML на выход, соответственно нужна XSD.
Запросы сервис принимает в очередь GETPHONEBYFIO.INPUT на ActiveMQ самой шины, ответы отдает в GETPHONEBYFIO.OUTPUT.
Так как сервис еще в разработке коллегами (эмулируем стандартную рабочую ситуацию :)) - под него нужно написать заглушку и поднять параллельно с сервисом для тестов.
А еще сервис может быть не поднят - тогда твой сервис должен ожидать ответ в течение заданного таймаута (пусть 5 секунд) и обрабатывть эту ситуацию корректно.

Итого. Работать с БД нужно через Hibernate/Java Persistence API. 
Веб-сервис поднимать на CXF.
Работать с ActiveMQ на твой выбор - либо JMS, либо встроенный компонент Camel ActiveMQ.
PostgreSQL можешь поднять либо в докере (круто, но придется помучиться с докером), либо просто на винде - как удобнее.

Важно работать также с транзакциями - не допускай сохранение левых данных в БД при ошибках.

Выглядит страшновато для начала, но есть ощущение, что ты справишься :) 
По этапам:
1) Сделай XSD и WSDL
2) Сделай MVP сервиса (можно без работы с getPhoneByFIO, без транзакций, без обработки SOAP-FAULT и валидации - только “положительные" сценарии)
3) Сделай тестовый проект на soapUI, чтобы сервис можно было удобно дергать при отладке
4) Занимайся остальными требованиями по мере возможности
5) После реализации всех плюшек - покрой тестами, что считаешь нужным

По времени - на XSD/WSDL и MVP сервиса - до конца недели. 

Если есть вопросы или что-то не ясно - обращайся. Но не факт, что смогу ответить в какое-то внятное время.

В целом по вопросам обращайся к Максиму Сухаренко - он укажет, кто сможет тебе помочь с конкретными проблемами.

С уважением, Вадим Аксельрод.
Ведущий разработчик
Отдел разработки программного обеспечения
___________________________
Компания «Синимекс»
Моб.: +7 (965) 307-86-25
E-mail: vakselrod@cinimex.ru
www.cinimex.ru




